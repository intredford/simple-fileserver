<!DOCTYPE html>
<html lang="ru">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel = "stylesheet" href = "./font/Inter/style.css">
	<link rel = "stylesheet" href = "./css/main.css">
	<link rel = "stylesheet" href = "./css/index.css">

	<link rel="icon" type="image/png" href="/favicon.png">

	<title>–§–∞–π–ª–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä‚Ää/‚Ää–∑–∞–≥—Ä—É–∑–∫–∞</title>

	<script type="module">
		Array.prototype.last = function() { return this[this.length - 1] }
		import { createApp } from './js/petite-vue.min.js'

		createApp({
			files: [ ],
			deleteAfter: 24,
			noDelete: false,
			dragging: false,
			uploaded: false,
			error: false,
			
			handleFiles(event) {
				const files = event.target.files
				console.log(files)

				if (this.uploaded && files.length > 0) {
					this.files = []
					this.uploaded = false
				}

				for (let file of files) {

					file = { 
						raw: file, // —Å–∞–º –æ–±—ä–µ–∫—Ç `File`
						progress: 0,
						previewError: false,
					}

					file.name = '/'+file.raw.name
					file.hasPreview = file.raw.type.includes('image') && file.raw.size < 15*1024*1024

					if (file.hasPreview) {
						// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –ø—Ä–µ–≤—å—é –∫–∞—Ä—Ç–∏–Ω–∫–∞–º
						const reader = new FileReader()
						reader.onload = (e) => {
							file.preview = e.target.result
							this.files.push(file)
						}
						reader.readAsDataURL(file.raw)
					} else {
						// –ò–∑–≤–ª–µ–∫–∞–µ–º —Ñ–æ—Ä–º–∞—Ç
						file.format = file.name.split('.').last().toLowerCase()
						this.files.push(file)
					}
				}
			},

			handleDrop(event) {
				this.handleFiles({ 'target': { 'files': event.dataTransfer.files } })
				this.dragging = false
			},

			removeFile(index) {
				this.files.splice(index, 1)
			},

			setPreviewError(index) {
				this.files[index].previewError = true
				const files = [ ...this.files ]
				this.files = [  ]
				this.$nextTick(() => {
					this.files = [...files] // –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–æ–∫
				})
				// –°–ø–æ—Å–æ–± –≥–æ–≤–Ω–æ, –Ω–æ –¥—Ä—É–≥–æ–≥–æ —è –Ω–µ –ø—Ä–∏–¥—É–º–∞–ª. –ü—Ä–æ—Å—Ç–æ —Ç–∞–∫ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, $forceUpdate —Ç—É—Ç –Ω–µ—Ç.
			},

			uploadFiles() {
				const xhr = new XMLHttpRequest() // fetch –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç progress
				const form = new FormData()

				this.error = false

				form.append('deleteAfter', this.deleteAfter)
				form.append('noDelete', this.noDelete)

				this.files.forEach((file, index) => {
					form.append(file.raw.name, file.name)
				}) // –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞ : –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ –∏–º—è –∏ –ø—É—Ç—å

				this.files.forEach((file, index) => {
					form.append('files', file.raw)
				}) // –¢–∞–∫ –Ω–∞–¥–æ. –í—Å–µ —Ñ–∞–π–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤ –∫–æ–Ω—Ü–µ, –∏–Ω–∞—á–µ Multer –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –æ–±–æ—Å—Ä—ë—Ç—Å—è.

				xhr.upload.addEventListener('progress', event => {
					console.log(event)
					if (event.lengthComputable) {
						const progress = Math.round((event.loaded / event.total) * 100)
						this.files.forEach(file => { file.progress = progress })
					}
				})

				xhr.open('POST', '/api/upload')

				xhr.setRequestHeader('Authorization', 'Basic ' + (prompt('–ü–∞—Ä–æ–ª—å')))

				xhr.send(form)

				xhr.onload = () => {
					const response = JSON.parse(xhr.responseText);

					if (xhr.status === 200) {

						this.error = false

						this.files.forEach((file, i) => { // –¥–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫–∏ –∏ qr-–∫–æ–¥—ã
							file.link = response[i].link 
							file.QRCode = response[i].QRCode
						})
						this.uploaded = true

						document.querySelectorAll('input[name="url"]').forEach(input => { // –ø—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤—Å–µ –∏–Ω–ø—É—Ç—ã –≤ –∫–æ–Ω–µ—Ü
							input.focus();
							input.setSelectionRange(input.value.length, input.value.length);
							input.blur();
						});

					} else if (xhr.status === 401) {
						alert(response.message)
						this.error = true
					} else {
						alert(`–û—à–∏–±–∫–∞ ${xhr.status}` + response.message ? `\n ${response.message}` : '')
						this.error = true
					}
				};

			},

			hourLabel() {
				const hours = this.deleteAfter
				if (hours % 10 === 1 && hours % 100 !== 11) return "—á–∞—Å"
				if (hours % 10 >= 2 && hours % 10 <= 4 && (hours % 100 < 10 || hours % 100 >= 20)) return "—á–∞—Å–∞"
				return "—á–∞—Å–æ–≤"
			},

			showInfo() {
				alert(
`# –§–∞–π–ª–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

1. –í—ã–±–µ—Ä–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã.
2. –ï—Å–ª–∏ –Ω–∞–¥–æ, –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—É—Ç—å. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –≤—ã –Ω–∞–ø–∏—à–∏—Ç–µ \`/test/path/example.png\`, —Ç–æ —Ñ–∞–π–ª –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ —ç—Ç–æ–º—É –ø—É—Ç–∏. –°–ª–µ—à –≤ –Ω–∞—á–∞–ª–µ —Å—Ç–∞–≤–∏—Ç—å –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ.
3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–∞—Ä–æ–ª—å.
4. –ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å —Ñ–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º –∞–¥—Ä–µ—Å–∞–º.

–ï—Å–ª–∏ –≤—ã —É–∫–∞–∑–∞–ª–∏ –ø—É—Ç—å, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É —É–∂–µ –ª–µ–∂–∏—Ç —Ñ–∞–π–ª —Å —Ç–∞–∫–∏–º –∂–µ –∏–º–µ–Ω–µ–º, –æ–Ω –±—É–¥–µ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω.

–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ —É–∫–∞–∑—ã–≤–∞–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞, –∏–Ω–∞—á–µ –æ–Ω –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –Ω–µ–∫–∫–æ—Ä–µ–∫—Ç–Ω–æ (—Ö–æ—Ç—è –µ—Å–ª–∏ –µ–≥–æ —Å–∫–∞—á–∞—Ç—å –∏ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –µ–º—É —Ñ–æ—Ä–º–∞—Ç –æ–±—Ä–∞—Ç–Ω–æ, –≤—Å—ë –±—É–¥–µ—Ç –≤ –ø–æ—Ä—è–¥–∫–µ). 

–ê—Ö—Ç—É–Ω–≥! –§–∞–π–ª–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –¥–µ–ª–∏—Ç—å—Å—è —Ñ–∞–π–ª–∞–º–∏. –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏!
`) 
			}
		}).mount()
	</script>
</head>

<body 
	v-data="fileUpload()"
	@drop.prevent="handleDrop" 
	@dragenter.stop="dragging=true"
	@dragleave.stop="dragging=false"
	@dragover.stop.prevent
	@click = "dragging=false"
>

	<noscript class = "noscript">
		<header>
			–í–∫–ª—é—á–∏—Ç–µ JavaScript
		</header>
	</noscript>

	<form 
		class = "form" 
		enctype="multipart/form-data"
		:style = "{ 'pointer-events': dragging ? 'none' : 'auto' }"
		@submit.prevent="uploadFiles"
	>
		
		<div style = "width: fit-content; margin: auto;">
			<input 
				type="file" 
				id="fileInput" 
				name="files" 
				multiple 
				accept="*/*" 
				@input="handleFiles"
			>
			<label class = "form-file" for = "fileInput">üìé –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã</label>
			<div 
				class = "drag-n-drop"
				v-show = "dragging"
			></div>
		</div>

		<div v-if = "files.length">
			<hr style = "margin-top: 1em">

			<div class = "files">
				<div 
					class = "file"
					v-for = "file, index in files"
				>

					<div class = "file-preview">

						<img
							v-if = "file.hasPreview"
							:src = "file.preview"
						>
						<img
							v-else-if = "!file.previewError"
							class = "icon"
							:src = "`/icons/high-contrast/${file.format}.svg`"
							@error = "setPreviewError(index)"
						>
						<span
							v-else-if = "file.format.length <= 4"
							class = "file-format"
							>
							{{ file.format }}
						</span>
						<img
							v-else
							class = "icon"
							:src = "`/icons/high-contrast/blank.svg`"
						>
					</div>

					<div 
						class = "file-name"
					>
						<input 
							v-model = "file.link ? file.link : file.name" 
							name = "url"
							size = "22"
							placeholder="URL —Ñ–∞–π–ª–∞"
							title = "–§–æ—Ä–º–∞—Ç—ã –±—É–¥–µ—Ç –ø—Ä–∏–≤–µ–¥–µ–Ω—ã –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É"
							v-bind = "file.link ? { readonly: true } : {}"
							required
						>
						<div class = "file-progress">
							<div 
								class = "file-progress-value"
								:style = "{ 
									width: file.progress + '%',
									'background-color': file.progress < 100 ? '#0073ee' : error ? 'red' : '#67d264'
								}"
								v-if = "file.progress"
							></div>
						</div>
					</div>

					<div class = "file-remove" v-if = "!file.QRCode">
						<button @click = "removeFile(index)" type = "button"><span>‚ï≥</span></button>
					</div>

					<img
						class = "file-qrcode"
						:src = "file.QRCode"
						alt = "QR-–∫–æ–¥"
						v-else
					>

				</div>
			</div>

			<hr>

			<div class = "form-field" :class = "{'disabled': noDelete}">
				<label for="deleteAfter">–£–¥–∞–ª–∏—Ç—å —á–µ—Ä–µ–∑</label>
				<input 
					v-model="deleteAfter"
					:disabled = "noDelete"
					type="number" 
					id="deleteAfter" 
					name="deleteAfter" 
					min="1" 
					size="2"
					step="1"
					required
					style="appearance: textfield; height: 1.5em"
				>
				<label for="deleteAfter">{{ hourLabel() }}</label>
			</div>

			<div class = "form-field">
				<input 
					type="checkbox" 
					id="noDelete" 
					name="noDelete"
					v-model="noDelete"
				><label for="noDelete">–ù–µ —É–¥–∞–ª—è—Ç—å</label>
			</div>

			<button 
				class = "form-upload"
				type="submit"
			>
				–ó–∞–≥—Ä—É–∑–∏—Ç—å
			</button>

		</div>
	
	</form>

	<button class = "info" @click = "showInfo" title = "–°–ø—Ä–∞–≤–∫–∞">?</button>

</body>

</html>